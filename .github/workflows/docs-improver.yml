name: Documentation Improver

on:
  schedule:
    - cron: '0 5 * * 3'  # Ð¡Ñ€ÐµÐ´Ð° Ð² 5:00 UTC
  workflow_dispatch:
  push:
    paths:
      - '**.py'
      - '**.md'

jobs:
  improve-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install openai pydoc-markdown
          
      - name: AI Documentation Enhancement
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import openai
          from pathlib import Path
          from datetime import datetime
          
          openai.api_key = os.environ.get('OPENAI_API_KEY')
          
          print("ðŸ“ Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸...\n")
          
          # ÐŸÐ¾Ð¸ÑÐº Python Ñ„Ð°Ð¹Ð»Ð¾Ð²
          py_files = list(Path('.').rglob('*.py'))
          py_files = [f for f in py_files if '.git' not in str(f) and 'venv' not in str(f)]
          
          print(f"ðŸ“„ ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ {len(py_files)} Python Ñ„Ð°Ð¹Ð»Ð¾Ð²")
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸
          docs_dir = Path('docs-generated')
          docs_dir.mkdir(exist_ok=True)
          
          improved_count = 0
          
          if openai.api_key and openai.api_key != 'None':
              # ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 3 Ñ„Ð°Ð¹Ð»Ð°
              for py_file in py_files[:3]:
                  try:
                      with open(py_file, 'r', encoding='utf-8') as f:
                          code = f.read()
                      
                      # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ
                      response = openai.chat.completions.create(
                          model="gpt-4",
                          messages=[
                              {"role": "system", "content": "Ð¢Ñ‹ ÑÐºÑÐ¿ÐµÑ€Ñ‚ Ð¿Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸ÑŽ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸. Ð¡Ð¾Ð·Ð´Ð°Ð¹ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½ÑƒÑŽ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ ÐºÐ¾Ð´Ð°."},
                              {"role": "user", "content": f"Ð¡Ð¾Ð·Ð´Ð°Ð¹ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½ÑƒÑŽ markdown Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð°. Ð’ÐºÐ»ÑŽÑ‡Ð¸:\n- ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»Ð°\n- ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ\n- ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ\n\nÐšÐ¾Ð´:\n```python\n{code[:1500]}\n```"}
                          ],
                          temperature=0.3,
                          max_tokens=2000
                      )
                      
                      docs_content = response.choices[0].message.content
                      
                      # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ
                      doc_file = docs_dir / f"{py_file.stem}_docs.md"
                      with open(doc_file, 'w', encoding='utf-8') as f:
                          f.write(f"# Documentation: {py_file.name}\n\n")
                          f.write(f"**Ð¤Ð°Ð¹Ð»:** `{py_file}`\n\n")
                          f.write(f"**Ð”Ð°Ñ‚Ð°:** {datetime.now().strftime('%Y-%m-%d')}\n\n")
                          f.write("---\n\n")
                          f.write(docs_content)
                      
                      improved_count += 1
                      print(f"âœ… Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°: {doc_file}")
                      
                  except Exception as e:
                      print(f"âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° {py_file}: {e}")
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑ
          index_file = docs_dir / 'README.md'
          with open(index_file, 'w', encoding='utf-8') as f:
              f.write("# ðŸ“š Generated Documentation\n\n")
              f.write(f"**ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÐµÐµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
              f.write(f"**Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²:** {improved_count}\n\n")
              f.write("## ðŸ“„ Ð¤Ð°Ð¹Ð»Ñ‹ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸\n\n")
              
              for doc_file in docs_dir.glob('*_docs.md'):
                  f.write(f"- [{doc_file.stem}]({doc_file.name})\n")
          
          print(f"\nâœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²: {improved_count}")
          print("ðŸŽ‰ Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!")
          EOF
          
      - name: Commit documentation
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "Docs Improver"
          git add docs-generated/
          git diff --staged --quiet || git commit -m "ðŸ“ AI-generated documentation [automated]"
          git push || echo "No changes"
          
      - name: Summary
        run: |
          echo "## ðŸ“ Documentation Improvement Complete" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Documentation generated for Python files" >> $GITHUB_STEP_SUMMARY
