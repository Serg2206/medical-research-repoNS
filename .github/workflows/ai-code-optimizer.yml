name: AI Code Optimizer

on:
  schedule:
    - cron: '0 3 * * *'  # Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ Ð² 3:00 UTC
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '**.py'
      - '**.js'
      - '**.java'

jobs:
  ai-optimize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install openai python-dotenv gitpython pylint radon
          
      - name: AI Code Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import openai
          import subprocess
          from pathlib import Path
          import json
          from datetime import datetime
          
          openai.api_key = os.environ.get('OPENAI_API_KEY')
          
          def analyze_code_with_ai(file_path, code_content):
              """ÐÐ½Ð°Ð»Ð¸Ð· ÐºÐ¾Ð´Ð° Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ GPT-4"""
              try:
                  response = openai.chat.completions.create(
                      model="gpt-4",
                      messages=[
                          {"role": "system", "content": "Ð¢Ñ‹ ÑÐºÑÐ¿ÐµÑ€Ñ‚ Ð¿Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ñƒ ÐºÐ¾Ð´Ð° Ð¸ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸. ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ ÐºÐ¾Ð´ Ð½Ð° Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸, Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸, Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ð¾ÑÑ‚Ð¸ Ð¸ best practices."},
                          {"role": "user", "content": f"ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ ÑÑ‚Ð¾Ñ‚ ÐºÐ¾Ð´ Ð¸ Ð´Ð°Ð¹ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸ÑŽ:\n\nÐ¤Ð°Ð¹Ð»: {file_path}\n\n{code_content}"}
                      ],
                      temperature=0.3,
                      max_tokens=2000
                  )
                  return response.choices[0].message.content
              except Exception as e:
                  return f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð°Ð½Ð°Ð»Ð¸Ð·Ð°: {str(e)}"
          
          def get_code_metrics(file_path):
              """ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¼ÐµÑ‚Ñ€Ð¸Ðº ÐºÐ¾Ð´Ð°"""
              try:
                  # Cyclomatic complexity
                  cc_result = subprocess.run(
                      ['radon', 'cc', file_path, '-s'],
                      capture_output=True, text=True
                  )
                  
                  # Maintainability index
                  mi_result = subprocess.run(
                      ['radon', 'mi', file_path, '-s'],
                      capture_output=True, text=True
                  )
                  
                  return {
                      'complexity': cc_result.stdout,
                      'maintainability': mi_result.stdout
                  }
              except Exception as e:
                  return {'error': str(e)}
          
          # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð²ÑÐµ Python Ñ„Ð°Ð¹Ð»Ñ‹
          python_files = list(Path('.').rglob('*.py'))
          python_files = [f for f in python_files if '.git' not in str(f) and 'venv' not in str(f)]
          
          print(f"ðŸ” ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ {len(python_files)} Python Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°")
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²
          reports_dir = Path('ai-reports')
          reports_dir.mkdir(exist_ok=True)
          
          analysis_results = []
          
          for i, file_path in enumerate(python_files[:5], 1):  # ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 5 Ñ„Ð°Ð¹Ð»Ð¾Ð²
              print(f"\nðŸ“Š ÐÐ½Ð°Ð»Ð¸Ð· {i}/{min(5, len(python_files))}: {file_path}")
              
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      code = f.read()
                  
                  # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸
                  metrics = get_code_metrics(str(file_path))
                  
                  # AI Ð°Ð½Ð°Ð»Ð¸Ð·
                  if openai.api_key and openai.api_key != 'None':
                      ai_analysis = analyze_code_with_ai(str(file_path), code)
                  else:
                      ai_analysis = "âš ï¸ OPENAI_API_KEY Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ»ÑŽÑ‡ Ð² Settings â†’ Secrets â†’ Actions"
                  
                  result = {
                      'file': str(file_path),
                      'timestamp': datetime.now().isoformat(),
                      'metrics': metrics,
                      'ai_recommendations': ai_analysis,
                      'lines_of_code': len(code.splitlines())
                  }
                  
                  analysis_results.append(result)
                  
                  print(f"âœ… ÐÐ½Ð°Ð»Ð¸Ð· Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½: {file_path}")
                  
              except Exception as e:
                  print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð°Ð½Ð°Ð»Ð¸Ð·Ðµ {file_path}: {e}")
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
          report_file = reports_dir / f'code-analysis-{datetime.now().strftime("%Y%m%d-%H%M%S")}.json'
          with open(report_file, 'w', encoding='utf-8') as f:
              json.dump(analysis_results, f, indent=2, ensure_ascii=False)
          
          print(f"\nðŸ“„ ÐžÑ‚Ñ‡ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½: {report_file}")
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ markdown Ð¾Ñ‚Ñ‡ÐµÑ‚
          md_report = reports_dir / 'LATEST_AI_ANALYSIS.md'
          with open(md_report, 'w', encoding='utf-8') as f:
              f.write(f"# ðŸ¤– AI Code Analysis Report\n\n")
              f.write(f"**Ð”Ð°Ñ‚Ð°:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
              f.write(f"**ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²:** {len(analysis_results)}\n\n")
              
              for result in analysis_results:
                  f.write(f"## ðŸ“ {result['file']}\n\n")
                  f.write(f"**Ð¡Ñ‚Ñ€Ð¾Ðº ÐºÐ¾Ð´Ð°:** {result['lines_of_code']}\n\n")
                  f.write(f"### ðŸŽ¯ AI Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸:\n\n")
                  f.write(f"{result['ai_recommendations']}\n\n")
                  f.write("---\n\n")
          
          print(f"âœ… Markdown Ð¾Ñ‚Ñ‡ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½: {md_report}")
          print("\nðŸŽ‰ AI Ð°Ð½Ð°Ð»Ð¸Ð· ÐºÐ¾Ð´Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!")
          EOF
          
      - name: Commit analysis results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "AI Code Optimizer"
          git add ai-reports/
          git diff --staged --quiet || git commit -m "ðŸ¤– AI Code Analysis Report [automated]"
          git push || echo "No changes to push"
          
      - name: Create summary
        run: |
          echo "## ðŸ¤– AI Code Optimization Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Code analysis completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Reports saved to ai-reports/ directory" >> $GITHUB_STEP_SUMMARY
