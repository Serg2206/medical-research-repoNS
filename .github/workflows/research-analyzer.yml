name: Research Analyzer

on:
  schedule:
    - cron: '0 10 * * 1'  # ÐŸÐ¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 10:00 UTC
  workflow_dispatch:

jobs:
  research:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install openai requests beautifulsoup4
          
      - name: AI Research Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import openai
          from pathlib import Path
          from datetime import datetime
          import json
          
          openai.api_key = os.environ.get('OPENAI_API_KEY')
          
          print("ðŸ”¬ ÐÐ½Ð°Ð»Ð¸Ð· Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ ÐºÐ¾Ð´Ð°...\n")
          
          # ÐŸÐ¾Ð¸ÑÐº Ñ„Ð°Ð¹Ð»Ð¾Ð² Ñ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸ÑÐ¼Ð¸
          research_files = []
          for ext in ['*.md', '*.py', '*.ipynb']:
              research_files.extend(list(Path('.').rglob(ext)))
          
          research_files = [f for f in research_files if '.git' not in str(f)]
          
          print(f"ðŸ“š ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ {len(research_files)} Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°")
          
          research_dir = Path('research-insights')
          research_dir.mkdir(exist_ok=True)
          
          if openai.api_key and openai.api_key != 'None' and len(research_files) > 0:
              # ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 3 Ñ„Ð°Ð¹Ð»Ð°
              insights = []
              for file_path in research_files[:3]:
                  try:
                      with open(file_path, 'r', encoding='utf-8') as f:
                          content = f.read()[:2000]  # ÐŸÐµÑ€Ð²Ñ‹Ðµ 2000 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²
                      
                      response = openai.chat.completions.create(
                          model="gpt-4",
                          messages=[
                              {"role": "system", "content": "Ð¢Ñ‹ Ð½Ð°ÑƒÑ‡Ð½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸Ðº. ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ ÐºÐ¾Ð´ Ð¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹."},
                              {"role": "user", "content": f"ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ ÑÑ‚Ð¾Ñ‚ Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ Ñ„Ð°Ð¹Ð» Ð¸ Ð´Ð°Ð¹ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸:\n\nÐ¤Ð°Ð¹Ð»: {file_path}\n\n{content}"}
                          ],
                          temperature=0.4,
                          max_tokens=1500
                      )
                      
                      insights.append({
                          'file': str(file_path),
                          'analysis': response.choices[0].message.content
                      })
                      
                      print(f"âœ… ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½: {file_path}")
                  except Exception as e:
                      print(f"âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° {file_path}: {e}")
              
              # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
              report_file = research_dir / f'research-analysis-{datetime.now().strftime("%Y%m%d")}.json'
              with open(report_file, 'w', encoding='utf-8') as f:
                  json.dump(insights, f, indent=2, ensure_ascii=False)
              
              # Markdown Ð¾Ñ‚Ñ‡ÐµÑ‚
              md_file = research_dir / 'LATEST_RESEARCH.md'
              with open(md_file, 'w', encoding='utf-8') as f:
                  f.write("# ðŸ”¬ Research Analysis Report\n\n")
                  f.write(f"**Ð”Ð°Ñ‚Ð°:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
                  f.write(f"**ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²:** {len(insights)}\n\n")
                  
                  for item in insights:
                      f.write(f"## ðŸ“ {item['file']}\n\n")
                      f.write(f"{item['analysis']}\n\n")
                      f.write("---\n\n")
              
              print(f"\nâœ… ÐžÑ‚Ñ‡ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½: {md_file}")
          else:
              print("âš ï¸ OPENAI_API_KEY Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð¸Ð»Ð¸ Ð½ÐµÑ‚ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°")
          
          print("\nðŸŽ‰ ÐÐ½Ð°Ð»Ð¸Ð· Ð¸ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!")
          EOF
          
      - name: Commit research insights
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "Research Analyzer"
          git add research-insights/
          git diff --staged --quiet || git commit -m "ðŸ”¬ Research analysis report [automated]"
          git push || echo "No changes"
          
      - name: Summary
        run: |
          echo "## ðŸ”¬ Research Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Research files analyzed" >> $GITHUB_STEP_SUMMARY
