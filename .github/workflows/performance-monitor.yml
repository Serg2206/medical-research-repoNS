name: Performance Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install psutil memory_profiler
          
      - name: Performance Monitoring
        run: |
          python << 'EOF'
          import psutil
          import os
          from pathlib import Path
          from datetime import datetime
          import json
          
          print("üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...\n")
          
          # –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
          cpu_percent = psutil.cpu_percent(interval=1)
          memory = psutil.virtual_memory()
          disk = psutil.disk_usage('.')
          
          # –†–∞–∑–º–µ—Ä —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          total_size = sum(f.stat().st_size for f in Path('.').rglob('*') if f.is_file())
          
          # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
          file_count = len(list(Path('.').rglob('*')))
          
          metrics = {
              'timestamp': datetime.now().isoformat(),
              'cpu_usage': cpu_percent,
              'memory_usage_mb': memory.used / (1024**2),
              'memory_percent': memory.percent,
              'disk_usage_gb': disk.used / (1024**3),
              'disk_percent': disk.percent,
              'repo_size_mb': total_size / (1024**2),
              'file_count': file_count
          }
          
          print(f"üíª CPU: {metrics['cpu_usage']:.1f}%")
          print(f"üíæ Memory: {metrics['memory_percent']:.1f}%")
          print(f"üìÄ Disk: {metrics['disk_percent']:.1f}%")
          print(f"üìÇ Repo size: {metrics['repo_size_mb']:.2f} MB")
          print(f"üìÑ Files: {metrics['file_count']}")
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
          perf_dir = Path('performance-logs')
          perf_dir.mkdir(exist_ok=True)
          
          log_file = perf_dir / f'metrics-{datetime.now().strftime("%Y%m%d-%H%M%S")}.json'
          with open(log_file, 'w') as f:
              json.dump(metrics, f, indent=2)
          
          # –°–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç
          report = perf_dir / 'LATEST_PERFORMANCE.md'
          with open(report, 'w') as f:
              f.write("# üìä Performance Monitoring Report\n\n")
              f.write(f"**–î–∞—Ç–∞:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
              f.write("## üìä System Metrics\n\n")
              f.write(f"- **CPU Usage:** {metrics['cpu_usage']:.1f}%\n")
              f.write(f"- **Memory Usage:** {metrics['memory_percent']:.1f}% ({metrics['memory_usage_mb']:.0f} MB)\n")
              f.write(f"- **Disk Usage:** {metrics['disk_percent']:.1f}% ({metrics['disk_usage_gb']:.2f} GB)\n")
              f.write(f"- **Repository Size:** {metrics['repo_size_mb']:.2f} MB\n")
              f.write(f"- **Total Files:** {metrics['file_count']}\n")
          
          print(f"\n‚úÖ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {report}")
          print("üéâ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω!")
          EOF
          
      - name: Commit logs
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "Performance Monitor"
          git add performance-logs/
          git diff --staged --quiet || git commit -m "üìä Performance monitoring report [automated]"
          git push || echo "No changes"
          
      - name: Summary
        run: |
          echo "## üìä Performance Monitoring Complete" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ System metrics collected" >> $GITHUB_STEP_SUMMARY
