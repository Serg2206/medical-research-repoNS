name: ML Pattern Learning

on:
  schedule:
    - cron: '0 4 * * 0'  # –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –ø–æ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è–º –≤ 4:00 UTC
  workflow_dispatch:

jobs:
  ml-learning:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install ML dependencies
        run: |
          pip install openai numpy pandas scikit-learn matplotlib seaborn joblib
          
      - name: ML Pattern Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import json
          import openai
          from pathlib import Path
          from datetime import datetime, timedelta
          import subprocess
          
          openai.api_key = os.environ.get('OPENAI_API_KEY')
          
          def analyze_patterns_with_ml():
              """–ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ML"""
              
              # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–∏—Ç–æ–≤
              result = subprocess.run(
                  ['git', 'log', '--pretty=format:%H|%an|%ae|%ad|%s', '--date=iso', '-100'],
                  capture_output=True, text=True
              )
              
              commits = []
              for line in result.stdout.strip().split('\n'):
                  if line:
                      parts = line.split('|')
                      if len(parts) == 5:
                          commits.append({
                              'hash': parts[0],
                              'author': parts[1],
                              'email': parts[2],
                              'date': parts[3],
                              'message': parts[4]
                          })
              
              print(f"üîç –ê–Ω–∞–ª–∏–∑ {len(commits)} –∫–æ–º–º–∏—Ç–æ–≤...")
              
              # –ê–Ω–∞–ª–∏–∑ —Å –ø–æ–º–æ—â—å—é GPT-4
              if openai.api_key and openai.api_key != 'None':
                  analysis_prompt = f"""
                  –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–º–∏—Ç–æ–≤.
                  –ù–∞–π–¥–∏:
                  1. –ß–∞—Å—Ç—ã–µ —Ç–∏–ø—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π
                  2. –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                  3. –û–±–ª–∞—Å—Ç–∏, —Ç—Ä–µ–±—É—é—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è
                  4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
                  
                  –ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–∏—Ç–æ–≤:
                  {json.dumps(commits[:20], indent=2, ensure_ascii=False)}
                  """
                  
                  try:
                      response = openai.chat.completions.create(
                          model="gpt-4",
                          messages=[
                              {"role": "system", "content": "–¢—ã ML-—ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –∏ –≤—ã—è–≤–ª—è–π –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏."},
                              {"role": "user", "content": analysis_prompt}
                          ],
                          temperature=0.5,
                          max_tokens=2000
                      )
                      
                      ml_insights = response.choices[0].message.content
                  except Exception as e:
                      ml_insights = f"‚ö†Ô∏è –û—à–∏–±–∫–∞ ML –∞–Ω–∞–ª–∏–∑–∞: {str(e)}"
              else:
                  ml_insights = "‚ö†Ô∏è OPENAI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
              
              return {
                  'commit_count': len(commits),
                  'ml_insights': ml_insights,
                  'timestamp': datetime.now().isoformat()
              }
          
          def analyze_code_frequency():
              """–ê–Ω–∞–ª–∏–∑ —á–∞—Å—Ç–æ—Ç—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ–∞–π–ª–æ–≤"""
              result = subprocess.run(
                  ['git', 'log', '--pretty=format:', '--name-only', '-100'],
                  capture_output=True, text=True
              )
              
              files = [f for f in result.stdout.split('\n') if f]
              file_freq = {}
              for f in files:
                  file_freq[f] = file_freq.get(f, 0) + 1
              
              # –¢–æ–ø-10 —Å–∞–º—ã—Ö –∏–∑–º–µ–Ω—è–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
              top_files = sorted(file_freq.items(), key=lambda x: x[1], reverse=True)[:10]
              
              return top_files
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è ML –æ—Ç—á–µ—Ç–æ–≤
          ml_dir = Path('ml-insights')
          ml_dir.mkdir(exist_ok=True)
          
          print("\nü§ñ –ó–∞–ø—É—Å–∫ ML –∞–Ω–∞–ª–∏–∑–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤...")
          
          # –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
          patterns = analyze_patterns_with_ml()
          
          # –ê–Ω–∞–ª–∏–∑ —á–∞—Å—Ç–æ—Ç—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π
          top_files = analyze_code_frequency()
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
          report = {
              'timestamp': datetime.now().isoformat(),
              'patterns': patterns,
              'top_changed_files': top_files
          }
          
          report_file = ml_dir / f'ml-analysis-{datetime.now().strftime("%Y%m%d-%H%M%S")}.json'
          with open(report_file, 'w', encoding='utf-8') as f:
              json.dump(report, f, indent=2, ensure_ascii=False)
          
          print(f"\nüìä ML –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {report_file}")
          
          # –°–æ–∑–¥–∞–µ–º markdown –æ—Ç—á–µ—Ç
          md_file = ml_dir / 'LATEST_ML_INSIGHTS.md'
          with open(md_file, 'w', encoding='utf-8') as f:
              f.write("# üß† ML Pattern Learning Report\n\n")
              f.write(f"**–î–∞—Ç–∞:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
              f.write(f"**–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–º–º–∏—Ç–æ–≤:** {patterns['commit_count']}\n\n")
              
              f.write("## üéØ ML Insights\n\n")
              f.write(f"{patterns['ml_insights']}\n\n")
              
              f.write("## üìà –¢–æ–ø-10 —Å–∞–º—ã—Ö –∏–∑–º–µ–Ω—è–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤\n\n")
              for file, count in top_files:
                  f.write(f"- `{file}`: {count} –∏–∑–º–µ–Ω–µ–Ω–∏–π\n")
              
              f.write("\n---\n")
              f.write("*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ML Pattern Learning System*\n")
          
          print(f"‚úÖ Markdown –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: {md_file}")
          print("\nüéâ ML –∞–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω!")
          EOF
          
      - name: Commit ML insights
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "ML Pattern Learner"
          git add ml-insights/
          git diff --staged --quiet || git commit -m "üß† ML Pattern Learning Report [automated]"
          git push || echo "No changes to push"
          
      - name: Create summary
        run: |
          echo "## üß† ML Pattern Learning Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Pattern analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "üìä Insights saved to ml-insights/ directory" >> $GITHUB_STEP_SUMMARY
